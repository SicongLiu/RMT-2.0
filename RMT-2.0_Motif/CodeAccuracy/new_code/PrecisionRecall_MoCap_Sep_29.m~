clear;
clc;

weighted = 0;

% iterate file to for upload
testCaseIndex = 1 : 10;
% TS_index = [17, 20, 33, 37, 38, 40, 52, 59, 61, 69, 71, 81, 83, 86, 91, 92, 100, 104, 113, 115, 121, 130, 132, 133, 138, 141, 142, 143, 148, 151]; % MoCap Dataset
TS_index = [17]; % MoCap Dataset

% strategy = [1 : 9];
% strategy = [1, 3, 4, 6, 7, 9];
strategy = [3];
% num_of_motif = [1:3];
num_of_motif = [2:3];
% amp_scale = [0, 0.1, 0.25, 0.5, 0.75, 1]; % 0.5 0.75 0 1
amp_scale = [0.1, 1]; % 0.5 0.75 0 1

GroundTruthFilePath = ['/Users/sliu104/Desktop/MyMotif/Silvestro_Sep_18_MoCap/GroundTruthMocap/FeaturePosition_Motif'];

% MatrixProfileFilePath = ['/Users/sicongliu/Desktop/MyMotif/EnergyComputeAccuracy/AccuracyMstamp'];
MatrixProfileFilePath = ['/Users/sliu104/Desktop/MyMotif/Silvestro_Sep_18_MoCap/Accuracy'];

% RMTMotifFilePath = ['/Users/sicongliu/Desktop/MyMotif/EnergyComputeAccuracy/AccuracyRMT'];
RMTMotifFilePath = ['/Users/sliu104/Desktop/MyMotif/Silvestro_Sep_18_MoCap/AccuracyMotif2_3'];

savePathRMT = ['/Users/sliu104/Desktop/MyMotif/Silvestro_Sep_18_MoCap/Result_RMT_Motif'];
savePathMatrixProfile = ['/Users/sliu104/Desktop/MyMotif/Silvestro_Sep_18_MoCap/Result_MStamp_Motif'];

MatrixProfileEntropy = [];
RMTMotifEntropy = [];

timeOverlapThresholds = [0.1, 0.25, 0.5, 0.75, 1];
for i = 1 : size(num_of_motif, 2)
    for ss = 1 : size(strategy, 2)
        for m = 1 : size(amp_scale, 2)
            for tt = 1 : size(timeOverlapThresholds, 2)
                current_iteration_precision_RMT = cell(size(TS_index, 2) * size(testCaseIndex, 2), 1);
                current_iteration_recall_RMT = cell(size(TS_index, 2) * size(testCaseIndex, 2), 1);
                current_iteration_FScore_RMT = cell(size(TS_index, 2) * size(testCaseIndex, 2), 1);
                
                current_iteration_precision_MatrixProfile = cell(size(TS_index, 2) * size(testCaseIndex, 2), 1);
                current_iteration_recall_MatrixProfile = cell(size(TS_index, 2) * size(testCaseIndex, 2), 1);
                current_iteration_FScore_MatrixProfile = cell(size(TS_index, 2) * size(testCaseIndex, 2), 1);
                index_count = 1; % keep track of same motif but different number of instances
                for j = 1 : size(TS_index, 2)
                    for k = 1 : size(testCaseIndex, 2)
                        fprintf('Num of motif: %d, Strategy: %d, TS index: %d, instance: %d, amp scale: %f, timeOverlapThreshold: %f .\n', num_of_motif(i), strategy(ss), TS_index(j), testCaseIndex(k), amp_scale(m), timeOverlapThresholds(tt));
                        GroundTruthFile = [GroundTruthFilePath, num2str(num_of_motif(i)), '_', num2str(TS_index(j)), '_instance_', num2str(testCaseIndex(i)), '_', num2str(amp_scale(m)), '.csv'];
                        
                        MatrixProfileFile = [MatrixProfileFilePath, '/Motif', num2str(num_of_motif(i)), '_', num2str(TS_index(j)), '_instance_', num2str(testCaseIndex(k)), '_', num2str(amp_scale(m)), '.csv'];
                        
                        % RMTMotifFile = [RMTMotifFilePath, num2str(num_of_motif(i)), '/Strategy_', num2str(strategy(ss)), '/AP_DepO_2_DepT_2_Motif', num2str(num_of_motif(i)), '_', num2str(TS_index(j)), '_instance_', num2str(testCaseIndex(k)), '_', num2str(amp_scale(m)), '.csv'];
                        RMTMotifFile = [RMTMotifFilePath, '/Strategy_', num2str(strategy(ss)), '/AP_DepO_2_DepT_2_Motif', num2str(num_of_motif(i)), '_', num2str(TS_index(j)), '_instance_', num2str(testCaseIndex(k)), '_', num2str(amp_scale(m)), '.csv'];
                        
                        threshold = eps; % if it is non-zero
                        timeOverlapThreshold = timeOverlapThresholds(tt);
                        % windowSize = 32; % BirdSong configuration
                        windowSize = 58; % Energy dataset configuration
                        if(weighted == 1)
                            % algorithmType = 'MatrixProfile';
                            % [currentMatrixProfileEntropy, precisionMatrixMatrixProfile, recallMatrixMatrixProfile, FScoreMatrixMatrixProfile] = motifEvaluationWeighted(GroundTruthFile, MatrixProfileFile, algorithmType, windowSize);
                            % algorithmType = 'RMT';
                            % [currentRMTMotifEntropy, precisionMatrixRMT, recallMatrixRMT, FScoreMatrixRMT] = motifEvaluationWeighted(GroundTruthFile, RMTMotifFile, algorithmType, windowSize);
                            
                            % algorithmType = 'RME';
                            % [currentRMEMotifEntropy, precisionMatrixRME, recallMatrixRME, FScoreMatrixRME] = motifEvaluationWeighted(GroundTruthFile, RMEMotifFile, algorithmType, windowSize);
                        else
                            % algorithmType = 'MatrixProfile';
                            % [currentMatrixProfileEntropy,  precisionMatrixMatrixProfile, recallMatrixMatrixProfile, FScoreMatrixMatrixProfile, total_index_MStamp] = motifEvaluation(GroundTruthFile, MatrixProfileFile, algorithmType, windowSize, threshold, timeOverlapThreshold);
                            
                            algorithmType = 'RMT';
                            [currentRMTMotifEntropy, precisionMatrixRMT, recallMatrixRMT, FScoreMatrixRMT, total_index_RMT] = motifEvaluation(GroundTruthFile, RMTMotifFile, algorithmType, windowSize, threshold, timeOverlapThreshold);
                            
                        end
                        
                        % MatrixProfileEntropy = [MatrixProfileEntropy ; currentMatrixProfileEntropy];
                        RMTMotifEntropy = [RMTMotifEntropy ; currentRMTMotifEntropy];
                        
                        % MatrixProfileEntropy = [MatrixProfileEntropy ; currentMatrixProfileEntropy];
                        % RMTMotifEntropy = [RMTMotifEntropy ; currentRMTMotifEntropy];
                        
                        
                        RMTsharedFolder = [savePathRMT, num2str(num_of_motif(i)), '/Strategy_', num2str(strategy(ss)), '/amp_scale_', num2str(amp_scale(m)), '_TO_', num2str(timeOverlapThreshold)];
                        MStampsharedFolder = [savePathMatrixProfile, num2str(num_of_motif(i)), '/Strategy_', num2str(strategy(ss)), '/amp_scale_', num2str(amp_scale(m)), '_TO_', num2str(timeOverlapThreshold)];
                        
                        if(exist(RMTsharedFolder,'dir')==0)
                            mkdir(RMTsharedFolder);
                        end
                        
                        % if(exist(MStampsharedFolder,'dir')==0)
                        %     mkdir(MStampsharedFolder);
                        % end
                        
                        savePathRMTPrecision = [RMTsharedFolder, '/RMTPrecision_', num2str(index_count), '.csv'];
                        savePathRMTRecall = [RMTsharedFolder, '/RMTRecall_', num2str(index_count), '.csv'];
                        savePathRMTFScore = [RMTsharedFolder, '/RMTFScore_', num2str(index_count), '.csv'];
                        savePathRemainIndex = [RMTsharedFolder, '/RemainIndex', num2str(index_count), '.csv'];
                        csvwrite(savePathRMTPrecision, precisionMatrixRMT);
                        csvwrite(savePathRMTRecall, recallMatrixRMT);
                        csvwrite(savePathRMTFScore, FScoreMatrixRMT);
                        csvwrite(savePathRemainIndex, total_index_RMT);
                        
                        % savePathMStampPrecision = [MStampsharedFolder, '/MStampPrecision_', num2str(index_count), '.csv'];
                        % savePathMStampRecall = [MStampsharedFolder, '/MStampRecall_', num2str(index_count), '.csv'];
                        % savePathMStampFScore = [MStampsharedFolder, '/MStampFScore_', num2str(index_count), '.csv'];
                        % savePathRemainIndex = [MStampsharedFolder, '/RemainIndex', num2str(index_count), '.csv'];
                        % csvwrite(savePathMStampPrecision, precisionMatrixMatrixProfile);
                        % csvwrite(savePathMStampRecall, recallMatrixMatrixProfile);
                        % csvwrite(savePathMStampFScore, FScoreMatrixMatrixProfile);
                        % csvwrite(savePathRemainIndex, total_index_MStamp);
                        
                        current_iteration_precision_RMT{index_count} = precisionMatrixRMT;
                        current_iteration_recall_RMT{index_count} = recallMatrixRMT;
                        current_iteration_FScore_RMT{index_count} = FScoreMatrixRMT;
                        
                        current_iteration_precision_MatrixProfile{index_count} = precisionMatrixMatrixProfile;
                        current_iteration_recall_MatrixProfile{index_count} = recallMatrixMatrixProfile;
                        current_iteration_FScore_MatrixProfile{index_count} = FScoreMatrixMatrixProfile;
                        
                        index_count = index_count + 1;
                    end
                end
                
                cur_num_of_motif = num_of_motif(i);
                % able to aggregate the precision and recall
                % information here
                for kk = 1 : size(algorithm_type, 2)
                    aggregated_precision_file = [precision_file_path, 'aggregated.csv'];
                    aggregated_recall_file = [recall_file_path, 'aggregated.csv'];
                    aggregated_FScore_file = [FScore_file_path, 'aggregated.csv'];
                    
                    aggregated_precision = zeros(index_count, cur_num_of_motif+1+1);
                    aggregated_recall = zeros(index_count, cur_num_of_motif+1+1);
                    aggregated_FScore = zeros(index_count, cur_num_of_motif+1+1);
                    
                    for ii = 1 : index_count
                        precision_matrix = 
                        recall_matrix
                        FScore_matrix
                        
                        new_precision_matrix = zeros(size(precision_matrix, 1) + 1, size(precision_matrix, 2) + 1);
                        new_recall_matrix = zeros(size(recall_matrix, 1) + 1, size(recall_matrix, 2) + 1);
                        new_FScore_matrix = zeros(size(FScore_matrix, 1) + 1, size(FScore_matrix, 2) + 1);
                        
                        num_output_class = size(precision_matrix, 1);
                        num_of_class = size(precision_matrix, 2);
                        
                        for jj = 1 : num_output_class
                            new_precision_matrix(jj, 1 : size(precision_matrix, 2)) = precision_matrix(jj, :);
                            if(sum(isnan(precision_matrix(jj, :)) > 0))
                                my_precision = max(precision_matrix(jj, :));
                            else
                                my_precision = mean(precision_matrix(jj, :));
                            end
                            new_precision_matrix(jj, size(new_precision_matrix, 2)) = my_precision;
                            
                            new_recall_matrix(jj, 1 : size(recall_matrix, 2)) = recall_matrix(jj, :);
                            if(sum(isnan(recall_matrix(jj, :)) > 0))
                                my_recall = max(recall_matrix(jj, :));
                            else
                                my_recall = mean(recall_matrix(jj, :));
                            end
                            new_recall_matrix(jj, size(new_recall_matrix, 2)) = my_recall;
                            
                            new_FScore_matrix(jj, 1 : size(FScore_matrix, 2)) = FScore_matrix(jj, :);
                            if(sum(isnan(FScore_matrix(jj, :)) > 0))
                                my_FScore = max(FScore_matrix(jj, :));
                            else
                                my_FScore = mean(FScore_matrix(jj, :));
                            end
                            new_FScore_matrix(jj, size(new_FScore_matrix, 2)) = my_FScore;
                        end
                        
                    end
                end
                
                
                
                
                
                clear current_iteration_precision current_iteration_recall current_iteration_FScore
                
                
            end
        end
    end
    
end

fprintf('All done .\n');
